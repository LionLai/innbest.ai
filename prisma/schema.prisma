// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// 訂單資料表（核心）
// =====================================================
model Booking {
  id                String   @id @default(cuid())
  
  // Beds24 資訊
  beds24BookingId   Int?     // Beds24 訂單 ID（付款後才創建）
  propertyId        Int
  roomId            Int
  roomName          String
  
  // 日期
  checkIn           DateTime
  checkOut          DateTime
  nights            Int
  
  // 客人資訊
  guestName         String
  guestEmail        String
  guestPhone        String
  guestAddress      String?  @db.Text // 客人地址
  adults            Int
  children          Int      @default(0)
  specialRequests   String?  @db.Text
  
  // 價格
  totalAmount       Decimal  @db.Decimal(10, 2)
  currency          String   @default("JPY")
  priceBreakdown    Json?    // { "2025-01-15": 12000, "2025-01-16": 12000 }
  
  // 狀態
  status            BookingStatus @default(PENDING)
  failureReason     String?  @db.Text // 失敗原因（如果有）
  
  // 關聯
  paymentId         String?  @unique
  payment           Payment? @relation(fields: [paymentId], references: [id])
  syncLogs          SyncLog[]
  
  // 時間戳記
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([guestEmail])
  @@index([checkIn])
  @@index([status])
  @@index([beds24BookingId])
  @@map("bookings")
}

enum BookingStatus {
  PENDING                 // 已創建，等待付款
  PAYMENT_PROCESSING      // 付款處理中
  PAYMENT_COMPLETED       // 付款成功，等待創建 Beds24 訂單
  BEDS24_CREATING         // 正在創建 Beds24 訂單
  CONFIRMED               // Beds24 訂單已確認
  BEDS24_FAILED           // Beds24 創建失敗，已退款
  CANCELLED               // 用戶取消
  REFUNDED                // 已退款
  EXPIRED                 // 付款逾時（15分鐘未付款）
}

// =====================================================
// 金流資料表
// =====================================================
model Payment {
  id                    String   @id @default(cuid())
  
  // Stripe 資訊
  stripePaymentIntentId String   @unique
  stripeCheckoutId      String?
  stripeRefundId        String?  // 退款 ID（如果有）
  
  // 金額
  amount                Decimal  @db.Decimal(10, 2)
  currency              String
  
  // 狀態
  status                PaymentStatus @default(PENDING)
  
  // Metadata from Stripe
  metadata              Json?
  
  // 錯誤處理
  failureReason         String?  @db.Text
  
  // 關聯
  booking               Booking?
  
  // 時間戳記
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  paidAt                DateTime?
  refundedAt            DateTime?
  
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([paidAt])
  @@map("payments")
}

enum PaymentStatus {
  PENDING               // 等待付款
  PROCESSING            // 處理中
  SUCCEEDED             // 成功
  FAILED                // 失敗
  CANCELLED             // 已取消
  REFUNDED              // 已退款
}

// =====================================================
// Beds24 同步記錄表
// =====================================================
model SyncLog {
  id                String   @id @default(cuid())
  
  bookingId         String
  booking           Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  action            SyncAction   // "CREATE", "UPDATE", "CANCEL"
  status            SyncStatus   // "SUCCESS", "FAILED", "PENDING"
  
  beds24Response    Json?    // Beds24 API 回應
  errorMessage      String?  @db.Text
  retryCount        Int      @default(0) // 重試次數
  
  createdAt         DateTime @default(now())
  
  @@index([bookingId])
  @@index([status])
  @@index([createdAt])
  @@map("sync_logs")
}

enum SyncAction {
  CREATE
  UPDATE
  CANCEL
  REFUND
}

enum SyncStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

// =====================================================
// 房間雜項費用表
// =====================================================
model RoomFee {
  id            String   @id @default(cuid())
  
  // 房間識別
  propertyId    Int      // Beds24 Property ID
  roomId        Int      // Beds24 Room ID
  
  // 費用資訊
  feeName       String   // 費用名稱（例如：清潔費、住宿稅）
  feeNameEn     String?  // 英文名稱（選填）
  amount        Decimal  @db.Decimal(10, 2) // 固定金額
  currency      String   @default("JPY")
  
  // 設定
  isActive      Boolean  @default(true)  // 是否啟用
  displayOrder  Int      @default(0)     // 顯示順序
  
  // 說明
  description   String?  @db.Text        // 內部備註
  
  // 時間戳
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([propertyId, roomId, feeName])
  @@index([propertyId, roomId, isActive])
  @@map("room_fees")
}

// =====================================================
// 業主資料表
// =====================================================
model Owner {
  id              String   @id @default(cuid())
  
  // 基本資訊
  email           String   @unique
  name            String
  nameEn          String?
  phone           String?
  
  // 認證（使用 Supabase Auth）
  supabaseUserId  String   @unique
  
  // 狀態
  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?
  
  // 物業關聯
  properties      OwnerProperty[]
  
  // 通知設定
  notifications   OwnerNotificationSettings?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([email])
  @@index([isActive])
  @@map("owners")
}

// =====================================================
// 業主-物業關聯表
// =====================================================
model OwnerProperty {
  id          String   @id @default(cuid())
  
  ownerId     String
  owner       Owner    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  propertyId  Int      // Beds24 Property ID
  
  // 權限設定（未來可擴展）
  canViewBookings    Boolean @default(true)
  canViewRevenue     Boolean @default(true)
  canViewStats       Boolean @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([ownerId, propertyId])
  @@index([ownerId])
  @@index([propertyId])
  @@map("owner_properties")
}

// =====================================================
// 業主通知設定表
// =====================================================
model OwnerNotificationSettings {
  id                      String   @id @default(cuid())
  
  ownerId                 String   @unique
  owner                   Owner    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Email 通知設定
  emailOnNewBooking       Boolean @default(true)
  emailOnCancellation     Boolean @default(true)
  emailWeeklyReport       Boolean @default(true)
  emailMonthlyReport      Boolean @default(true)
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  @@map("owner_notification_settings")
}
